{% extends 'base.html' %}

{% block content %}
    <div class="pagetitle mb-4">
        <h1>è¯­ä¹‰åˆ†æ</h1>
        <nav>
            <ol class="breadcrumb mt-2">
                <li class="breadcrumb-item"><a href="/index">é¦–é¡µ</a></li>
                <li class="breadcrumb-item">{{ contact.name }}</li>
                <li class="breadcrumb-item active">è¯­ä¹‰åˆ†æ</li>
            </ol>
        </nav>
    </div>

    <section class="section dashboard">
        <div class="row">
            <!-- ç¬¬ä¸€è¡Œï¼šå…³é”®è¯åˆ†æã€è¯é¢˜åˆ†å¸ƒå’Œæƒ…æ„Ÿåˆ†æ -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">ğŸ”‘ å…³é”®è¯åˆ†æ</h5>
                            <button class="btn btn-primary btn-sm" onclick="generateKeywordsCloud()">
                                <i class="bi bi-gear"></i> ç”Ÿæˆå›¾è¡¨
                            </button>
                        </div>
                        <div id="keywordsCloud" style="min-height: 400px;" class="echart"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">ğŸ—‚ï¸è¯é¢˜åˆ†å¸ƒ</h5>
                            <button class="btn btn-primary btn-sm" onclick="generateTopicsChart()">
                                <i class="bi bi-gear"></i> ç”Ÿæˆå›¾è¡¨
                            </button>
                        </div>
                        <div id="topicsChart" style="min-height: 400px;" class="echart"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">ğŸ˜Š æƒ…æ„Ÿåˆ†æ</h5>
                            <button class="btn btn-primary btn-sm" onclick="generateSentimentChart()">
                                <i class="bi bi-gear"></i> ç”Ÿæˆå›¾è¡¨
                            </button>
                        </div>
                        <div id="sentimentChart" style="min-height: 400px;" class="echart"></div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šè¯é¢˜æ ‡ç­¾è¿½è¸ª -->
            <div class="col-12">
                <div class="card" style="height: 800px;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">ğŸ·ï¸ è¯é¢˜æ ‡ç­¾è¿½è¸ª</h5>
                            <div>
                                <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;"
                                        id="tagTimeGranularity">
                                    <option value="month">æŒ‰æœˆ</option>
                                    <option value="week">æŒ‰å‘¨</option>
                                    <option value="day">æŒ‰å¤©</option>
                                </select>
                                <button class="btn btn-primary btn-sm" onclick="generateTagTrendsChart()">
                                    <i class="bi bi-gear"></i> ç”Ÿæˆå›¾è¡¨
                                </button>
                            </div>
                        </div>
                        <div id="tagTrendsChart" style="height: 700px; width: 100%; margin: 0 auto;"
                             class="echart"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // æ ‡è®°å½“å‰é¡µé¢çš„å¯¼èˆªé¡¹ä¸ºæ¿€æ´»çŠ¶æ€
            const currentNav = document.querySelector(`a[href="/contact/{{ contact.id }}/semantic"]`);
            if (currentNav) {
                currentNav.classList.add('active');
                // å±•å¼€å¹¶é«˜äº®çˆ¶çº§èœå•
                const parentCollapse = currentNav.closest('.collapse');
                if (parentCollapse) {
                    parentCollapse.classList.add('show');
                    const parentNavLink = document.querySelector(`[data-bs-target="#${parentCollapse.id}"]`);
                    if (parentNavLink) {
                        parentNavLink.classList.remove('collapsed');
                        parentNavLink.classList.add('active-parent');
                    }
                }
            }

            // åŠ è½½å·²å­˜å‚¨çš„å›¾è¡¨æ•°æ®
            loadStoredCharts();
        });

        // åŠ è½½å·²å­˜å‚¨çš„å›¾è¡¨æ•°æ®
        function loadStoredCharts() {
            fetch(`/api/contacts/{{ contact.id }}/semantic/stats`)
                .then(response => response.json())
                .then(data => {
                    console.log('Loaded stored data:', data);
                    // å¦‚æœæœ‰å­˜å‚¨çš„æ•°æ®å°±æ˜¾ç¤º
                    if (data.keywords && data.keywords.tfidf) {
                        initKeywordsCloud({tfidf: data.keywords.tfidf});
                        document.querySelector('button[onclick="generateKeywordsCloud()"]').innerHTML =
                            '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }
                    if (data.topics && data.topics.keywords) {
                        initTopicsChart(data.topics);
                        document.querySelector('button[onclick="generateTopicsChart()"]').innerHTML =
                            '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }
                    if (data.sentiment) {
                        initSentimentChart(data.sentiment);
                        document.querySelector('button[onclick="generateSentimentChart()"]').innerHTML =
                            '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }
                    if (data.tags && data.tags.times) {  // æ£€æŸ¥æ ‡ç­¾æ•°æ®æ˜¯å¦å­˜åœ¨
                        initTagTrendsChart({trends: data.tags});
                        document.querySelector('button[onclick="generateTagTrendsChart()"]').innerHTML =
                            '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }
                })
                .catch(error => {
                    console.error('Error loading stored data:', error);
                });
        }

        // ç”Ÿæˆå…³é”®è¯äº‘å›¾
        function generateKeywordsCloud() {
            const button = document.querySelector('button[onclick="generateKeywordsCloud()"]');
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';

            fetch(`/api/contacts/{{ contact.id }}/semantic/generate/keywords`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    initKeywordsCloud(data);
                    button.innerHTML = '<i class="bi bi-check-circle"></i> å·²ç”Ÿæˆ';
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.innerHTML = '<i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥';
                    alert('ç”Ÿæˆå…³é”®è¯äº‘å›¾å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }, 2000);
                });
        }

        // ç”Ÿæˆè¯é¢˜åˆ†å¸ƒå›¾
        function generateTopicsChart() {
            const button = document.querySelector('button[onclick="generateTopicsChart()"]');
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';

            fetch(`/api/contacts/{{ contact.id }}/semantic/generate/topics`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    initTopicsChart(data);
                    button.innerHTML = '<i class="bi bi-check-circle"></i> å·²ç”Ÿæˆ';
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.innerHTML = '<i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥';
                    alert('ç”Ÿæˆè¯é¢˜åˆ†å¸ƒå›¾å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }, 2000);
                });
        }

        // ç”Ÿæˆæƒ…æ„Ÿåˆ†æå›¾
        function generateSentimentChart() {
            const button = document.querySelector('button[onclick="generateSentimentChart()"]');
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';

            fetch(`/api/contacts/{{ contact.id }}/semantic/generate/sentiment`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    initSentimentChart(data);
                    button.innerHTML = '<i class="bi bi-check-circle"></i> å·²ç”Ÿæˆ';
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.innerHTML = '<i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥';
                    alert('ç”Ÿæˆæƒ…æ„Ÿåˆ†æå›¾å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> é‡æ–°ç”Ÿæˆ';
                    }, 2000);
                });
        }

        // ç”Ÿæˆè¯é¢˜æ ‡ç­¾è¿½è¸ªå›¾
        function generateTagTrendsChart() {
            const button = document.querySelector('button[onclick="generateTagTrendsChart()"]');
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';

            const granularity = document.getElementById('tagTimeGranularity').value;

            fetch(`/api/contacts/{{ contact.id }}/semantic/generate/tags?granularity=${granularity}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    initTagTrendsChart({trends: data});
                    button.innerHTML = '<i class="bi bi-check-circle"></i> å·²ç”Ÿæˆ';
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.innerHTML = '<i class="bi bi-x-circle"></i> ç”Ÿæˆå¤±è´¥';
                    alert('ç”Ÿæˆè¯é¢˜æ ‡ç­¾è¿½è¸ªå›¾å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-gear"></i> ç”Ÿæˆå›¾è¡¨';
                    }, 2000);
                });
        }
    </script>
{% endblock %} 